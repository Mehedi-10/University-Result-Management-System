{% extends 'user_navbar.html' %}
{% block resultpage %}select_result_as_teacher.html{% endblock %}
{% load extra %}
{% block title %}{{ 'Before Final result' }}{% endblock %}
{% block style_content %}
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/teacherresult.css' %}">
    <link rel="stylesheet" href="{% static 'css/spreadsheet.css' %}">
    <style>
        #tab {
            border-collapse: collapse;
        }

        #tab td, th {
            border: 2px solid black;
            text-align: center;
            padding: 0;
            margin: 0;
        }

        #tab input:read-only {
            background-color: #EEF2FF !important;
            color: black;
        }

        #tab input {
            display: block;
            border: none;
            max-width: 100px;
            height: 30px;
            text-align: center;
            font-size: 10pt;
        }


        #tab .hello {
            background-color: #DADFF7 !important;
            color: black;
            padding: 0 !important;
            height: 20px !important;
        }

    </style>
{% endblock %}
{% block icone %}{% endblock %}
{% block content %}
    <div style="text-align: center ;padding-top: 17px; font-size: 19px">
        Comilla University <br>
        Department of Computer Science & Engineering<br>
        Semester: {{ cons.head.semester }} &nbsp;&nbsp; Session: 2018-19<br>
        Course Name: {{ cons.head.course }} <br>
        Course Code: {{ cons.head.course_code }} &nbsp;&nbsp;Full Marks: {{ cons.head.marks }}
        <br>
        <p style="font-weight: bold">Before Final</p>
    </div>
    <hr>


    <div id="hehe" style="height: 67vh; width: max-content;display: block;margin: auto; opacity: 0">

        <form id="po" method="POST" action="">
            {% csrf_token %}
            <table id="tab">
                <tr style="width:100%;">
                    <td style="min-width: 27px"></td>
                    <td class="hello A">A
                    </td>
                    <td id="B" oncontextmenu="myadd1(event)" class="hello B">B

                        <div id="floatB" class="list-group"
                             style="display: none; border: 1px solid #2E1760; border-radius: 0;
">
                            <button type="button" onclick="addcol()"
                                    class="btn btn-sm list-group-item list-group-item-action list-group-item-dark"
                                    style="border-radius: 0; border-bottom:1px solid black">
                                Insert
                            </button>
                            <button type="button" onclick="delcol()"
                                    class="btn btn-sm list-group-item list-group-item-action list-group-item-dark"
                                    style="border-radius: 0; border-bottom:0">
                                Delete
                            </button>
                        </div>
                    </td>
                    <td id="C" oncontextmenu="myadd1(event)" class="hello C">
                        C
                        <div id="floatC" class="list-group"
                             style="display: none; border: 1px solid #2E1760; border-radius: 0;
">
                            <button type="button" onclick="addcol()"
                                    class="btn btn-sm list-group-item list-group-item-action list-group-item-dark"
                                    style="border-radius: 0; border-bottom:1px solid black">
                                Insert
                            </button>
                            <button type="button" onclick="delcol()"
                                    class="btn btn-sm list-group-item list-group-item-action list-group-item-dark"
                                    style="border-radius: 0; border-bottom:0">
                                Delete
                            </button>
                        </div>
                    </td>
                    <td id="D" oncontextmenu="myadd1(event)" class="hello D">D
                        <div id="floatD" class="list-group"
                             style="display: none; border: 1px solid #2E1760; border-radius: 0;
">
                            <button type="button" onclick="addcol()"
                                    class="btn btn-sm list-group-item list-group-item-action list-group-item-dark"
                                    style="border-radius: 0; border-bottom:1px solid black">
                                Insert
                            </button>
                            <button type="button" onclick="delcol()"
                                    class="btn btn-sm list-group-item list-group-item-action list-group-item-dark"
                                    style="border-radius: 0; border-bottom:0">
                                Delete
                            </button>
                        </div>
                    </td>
                    <td id="E" oncontextmenu="myadd1(event)" class="hello E">E
                        <div id="floatE" class="list-group"
                             style="display: none; border: 1px solid #2E1760; border-radius: 0;
">
                            <button type="button" onclick="addcol()"
                                    class="btn btn-sm list-group-item list-group-item-action list-group-item-dark"
                                    style="border-radius: 0; border-bottom:1px solid black">
                                Insert
                            </button>
                            <button type="button" onclick="delcol()"
                                    class="btn btn-sm list-group-item list-group-item-action list-group-item-dark"
                                    style="border-radius: 0; border-bottom:0">
                                Delete
                            </button>
                        </div>
                    </td>
                    <td id="F" oncontextmenu="myadd1(event)" class="hello F">F
                        <div id="floatF" class="list-group"
                             style="display: none; border: 1px solid #2E1760; border-radius: 0;
">
                            <button type="button" onclick="addcol()"
                                    class="btn btn-sm list-group-item list-group-item-action list-group-item-dark"
                                    style="border-radius: 0; border-bottom:1px solid black">
                                Insert
                            </button>
                            <button type="button" onclick="delcol()"
                                    class="btn btn-sm list-group-item list-group-item-action list-group-item-dark"
                                    style="border-radius: 0; border-bottom:0">
                                Delete
                            </button>
                        </div>
                    </td>
                    <td id="G" oncontextmenu="myadd1(event)" class="hello G">G
                        <div id="floatG" class="list-group"
                             style="display: none; border: 1px solid #2E1760; border-radius: 0;
">
                            <button type="button" onclick="addcol()"
                                    class="btn btn-sm list-group-item list-group-item-action list-group-item-dark"
                                    style="border-radius: 0; border-bottom:1px solid black">
                                Insert
                            </button>
                            <button type="button" onclick="delcol()"
                                    class="btn btn-sm list-group-item list-group-item-action list-group-item-dark"
                                    style="border-radius: 0; border-bottom:0">
                                Delete
                            </button>
                        </div>
                    </td>
                    <td id="H" oncontextmenu="myadd1(event)" class="hello H">H
                        <div id="floatH" class="list-group"
                             style="display: none; border: 1px solid #2E1760; border-radius: 0;
">
                            <button type="button" onclick="addcol()"
                                    class="btn btn-sm list-group-item list-group-item-action list-group-item-dark"
                                    style="border-radius: 0; border-bottom:1px solid black">
                                Insert
                            </button>
                            <button type="button" onclick="delcol()"
                                    class="btn btn-sm list-group-item list-group-item-action list-group-item-dark"
                                    style="border-radius: 0; border-bottom:0">
                                Delete
                            </button>
                        </div>
                    </td>
                    <td id="I" oncontextmenu="myadd1(event)" class="hello I">I
                        <div id="floatI" class="list-group"
                             style="display: none; border: 1px solid #2E1760; border-radius: 0;
">
                            <button type="button" onclick="addcol()"
                                    class="btn btn-sm list-group-item list-group-item-action list-group-item-dark"
                                    style="border-radius: 0; border-bottom:1px solid black">
                                Insert
                            </button>
                            <button type="button" onclick="delcol()"
                                    class="btn btn-sm list-group-item list-group-item-action list-group-item-dark"
                                    style="border-radius: 0; border-bottom:0">
                                Delete
                            </button>
                        </div>
                    </td>
                    <td class="hello J">J

                    </td>
                </tr>

                {% for i,val in cons.constt|dicfast %}
                    <tr>
                        <td class="hello">
                            {{ i }}
                        </td>
                        <td>
                            <input id="{{ i }}{{ 'A' }}" name="{{ i }}{{ 'A' }}" class="spreadsheets"
                                   type="text"
                                   readonly value="{{ val.s_id }}"></td>
                        <td><input id="{{ i }}{{ 'B' }}" name="{{ i }}{{ 'B' }}" class="spreadsheets"
                                   type="text"
                                   value="{{ val.mid1 }}"></td>
                        <td class="C"><input id="{{ i }}{{ 'C' }}" name="{{ i }}{{ 'C' }}" class="spreadsheets"
                                             type="text"
                                             value="{{ val.mid2 }}"></td>
                        <td class="D"><input id="{{ i }}{{ 'D' }}" name="{{ i }}{{ 'D' }}" class="spreadsheets"
                                             type="text"
                                             value="{{ val.mid3 }}"></td>
                        <td class="E"><input id="{{ i }}{{ 'E' }}" name="{{ i }}{{ 'E' }}" class="spreadsheets"
                                             type="text"
                                             value="{{ val.class_test }}"></td>
                        <td class="F"><input id="{{ i }}{{ 'F' }}" name="{{ i }}{{ 'F' }}" class="spreadsheets"
                                             type="text"
                                             value="{{ val.presentation }}"></td>
                        <td class="G"><input id="{{ i }}{{ 'G' }}" name="{{ i }}{{ 'G' }}" class="spreadsheets"
                                             type="text"
                                             value="{{ val.attendance }}"></td>
                        <td class="H"><input id="{{ i }}{{ 'H' }}" name="{{ i }}{{ 'H' }}" class="spreadsheets"
                                             type="text"
                                             value="{{ val.assignment }}"></td>
                        <td class="I"><input id="{{ i }}{{ 'I' }}" name="{{ i }}{{ 'I' }}" class="spreadsheets"
                                             type="text"
                                             value="{{ val.extra_field }}"></td>
                        <td class="J"><input id="{{ i }}{{ 'J' }}" name="{{ i }}{{ 'J' }}" class="spreadsheets"
                                             type="text"
                                             value="{{ val.total }}"></td>
                    </tr>

                {% endfor %}
            </table>
        </form>
    </div>

    <div class="row" id="vanish" style="margin: 0px; padding-bottom: 11px;padding-top: 11px;">
        <div class="col" style="padding-left: 100px ;text-align: left">
            <input type="button" id="btn" value="export" onclick="window.print()">
        </div>
        <div class="col" style="padding-right: 100px ;text-align: right">
            <input type="button" id="onceclickable" value="submit">
        </div>
    </div>

{% endblock %}
{% block script %}
    <script>

        {#var start_time;#}
        {##}
        {#function start() {#}
        {#    start_time = new Date();#}
        {# } #}
        {##}
        {#function end() {#}
        {#    var now = new Date();#}
        {#    alert(now - start_time);#}
        {# } #}

        {#$('#btn').mousedown(start);#}
        {#$('#btn').mouseup(end);#}
        const url = "nothing";
        var colmx = 74;

        function addsum(sum1, sum2) {
            if (sum1.length == 0)
                sum1 = '0.0';
            if (sum2.length == 0)
                sum2 = '0.0';

            var a = 0, b = '0', c = 0, d = '0', cut1 = 0, cut2 = 0;
            var inx = sum1.indexOf('.');
            if (inx == -1)
                sum1 += '.0';
            else if (inx == 0)
                sum1 = '0' + sum1;

            inx = sum1.indexOf('.');
            if (inx != -1) {
                cut1 = inx;
                b = sum1.substring(cut1 + 1);
            }

            inx = sum2.indexOf('.');
            if (inx == -1)
                sum2 += '.0';
            else if (inx == 0)
                sum2 = '0' + sum2;
            inx = sum2.indexOf('.');
            if (inx != -1) {
                cut2 = inx;
                d = sum2.substring(cut2 + 1);
            }

            while (b.length < d.length)
                b += '0';
            while (d.length < b.length)
                d += '0';
            var num = 1;
            for (let i = 0; i < b.length; i++)
                num *= 10;
            a = parseInt(sum1.substring(0, cut1), 10);
            c = parseInt(sum2.substring(0, cut2), 10);
            var d1 = parseInt(b, 10);
            var d2 = parseInt(d, 10);
            d1 += d2;
            d2 = (d1 % num).toString();
            d1 -= d1 % num;
            var extra = '';
            for (let i = d2.length + 1; i < num.toString().length; i++)
                extra += '0'
            a = a + c + Math.floor(d1 / num);
            return a.toString() + '.' + extra + d2;
        }


        $('.spreadsheets').keydown(function (e) {
            if (e.which === 13) {
                var x = 1, y = $('.spreadsheets').index(this);
                if (y % 10 === 9)
                    x++;
                var index = $('.spreadsheets').index(this) + x;
                $('.spreadsheets').eq(index).focus();
            }
        });


        const button1 = document.querySelector('#onceclickable');


        {% if cons.submitted %}
            button1.disabled = true;
            button1.value = "submitted";
            const bu = document.getElementById('hehe')
            for (let i = 0; i < 900; i++) {
                try {
                    bu.getElementsByClassName('spreadsheets')[i].readOnly = true;
                } catch (e) {

                }

            }

        {% endif %}
        function containsAnyLetter(str) {
            return /[a-zA-Z]/.test(str);
        }

        const disableButton = () => {
            notempty();
            var sum = '0.0';
            for (let i = 66; i < curcolnum; i++) {
                var str = document.getElementById('0' + String.fromCharCode(i)).value;
                if (str === 'None' || countString(str, "(") !== 1 || countString(str, ")") !== 1 || (str.indexOf("(") > str.indexOf(")"))) {
                    alert('Field Name must be in "Field_name(Marks)" format.');
                    return;
                } else {
                    var strcut = str.substring(str.indexOf('(') + 1, str.length - 1);
                    if (containsAnyLetter(strcut)) {
                        alert('Field Name must be in "Field_name(Marks)" format.');
                        return;
                    }
                    sum = addsum(sum, strcut);
                }
            }
            if (sum !={{ cons.head.marks}}) {
                alert('Total Marks Condition Not satisfied.');
                return;
            }

            for (let i = 0; i < 90; i++) {
                for (let j = 66; j < curcolnum + 1; j++) {

                    try {
                        var str = document.getElementById(i.toString() + String.fromCharCode(j)).value;
                        if (j == curcolnum && str >{{ cons.head.marks }}) {
                            alert('Marks can\'t be greater than {{ cons.head.marks }} at cell ' + i.toString() + String.fromCharCode(j));
                            document.getElementById(i.toString() + String.fromCharCode(j)).focus();
                            return;
                        }
                        if (str.length == 0) {
                            alert('Cell ' + i.toString() + String.fromCharCode(j) + ' can\'t be empty');
                            document.getElementById(i.toString() + String.fromCharCode(j)).focus();
                            return;
                        }
                    } catch (e) {

                    }
                }
            }
            document.getElementById('po').submit();
            button1.disabled = true;
            button1.value = "submitted";
            const bu = document.getElementById('hehe')
            for (let i = 0; i < 900; i++) {
                try {
                    bu.getElementsByClassName('spreadsheets')[i].readOnly = true;
                } catch (e) {
                }

            }
        };
        button1.addEventListener('click', disableButton);

        function countString(str, letter) {
            let count = 0;

            for (let i = 0; i < str.length; i++) {
                if (str.charAt(i) === letter) {
                    count += 1;
                }
            }
            return count;
        }

        for (let i = 0; i < 900; i++) {
            for (let j = 65; j < 75; j++) {
                var x = i.toString();
                x += String.fromCharCode(j);
                try {
                    const inp = document.getElementById(x);
                    inp.addEventListener("input", myFunction);
                    if (inp.value === 'None' && x[0] > '0') {
                        inp.value = '';
                    }

                    function myFunction() {
                        var ss = inp.id, laststr = inp.value;
                        var lowerstr = laststr.toLowerCase();
                        if (lowerstr.includes('total')) {
                            laststr = 'None';
                            alert('Multiple TOTAL not allowed');
                        }
                        var ll = laststr.length;
                        if (ss[0] !== '0' && (laststr[ll - 1] < '0' || laststr[ll - 1] > '9')) {
                            if (countString(laststr, ".") > 1) {
                                alert('Please Insert only one Radix point at cell' + ss);
                                laststr = laststr.slice(0, -1);
                            } else if (laststr[ll - 1] != '.') {
                                alert('Please Insert only Numbers and at cell' + ss);
                                laststr = laststr.slice(0, -1);
                            }

                        }
                        notempty();
                        var total = '0';
                        inp.value = laststr;
                        var aaacellvalue = {};
                        for (let k = 65; k < 75; k++) {
                            try {
                                cell = inp.id;
                                cellid = cell.slice(0, -1) + String.fromCharCode(k);
                                if (cell.slice(0, -1) !== "0") {
                                    if (k > 65) {
                                        if (k < curcolnum)
                                            total = addsum(document.getElementById(cellid).value, total);
                                        else if (k === curcolnum)
                                            document.getElementById(cellid).value = total;
                                    }
                                }
                                aaacellvalue[cellid] = document.getElementById(cellid).value;
                            } catch (e) {
                            }
                        }


                        $.ajax({
                            type: "POST",
                            url: url,
                            data:
                                {
                                    aaacellvalue,
                                    csrfmiddlewaretoken: '{{ csrf_token }}'
                                }
                        });
                    }

                } catch (e) {

                }
            }
        }


        window.addEventListener('contextmenu', function (e) {
            e.preventDefault();
        }, false);

        window.addEventListener('click', function (e) {
            for (let i = 66; i < 75; i++) {
                var hideid = "float" + String.fromCharCode(i);
                try {
                    document.getElementById(hideid).style.display = 'none';
                } catch (e) {

                }

            }
            {# e.preventDefault();#}
        }, false);

        var operationid, curcolnum;

        function notempty() {
            curcolnum = colmx;
            while (curcolnum > 65) {
                var tmp = '0' + String.fromCharCode(curcolnum);
                var hi = document.getElementById(tmp);
                try {
                    if (hi.value !== 'None' && hi.value !== '')
                        break;
                } catch (e) {
                }
                curcolnum--;
            }
        }

        window.onload = function () {
            notempty();
            for (let i = curcolnum + 1; i < colmx + 1; i++) {
                var hid = '.';
                hid += String.fromCharCode(i);
                var willhide = document.querySelectorAll(hid);
                for (let j = 0; j < 90; j++) {
                    try {
                        willhide[j].style.display = "none";
                    } catch (e) {

                    }
                }
            }
            lastreadonly();
        }

        function lastreadonly() {
            notempty();
            for (let i = 0; i < 90; i++) {
                try {
                    var tmp = i.toString() + String.fromCharCode(curcolnum);
                    document.getElementById(tmp).setAttribute("readonly", "true");
                } catch (e) {

                }
            }
        }

        function clearreadonly() {
            notempty();
            for (let i = 0; i < 90; i++) {
                try {
                    var tmp = i.toString() + String.fromCharCode(curcolnum);
                    document.getElementById(tmp).removeAttribute("readonly", "true");
                } catch (e) {

                }
            }
        }


        function addcol() {
            notempty();
            clearreadonly();
            if (curcolnum !== colmx) {
                var hiden = '.' + String.fromCharCode(curcolnum + 1);
                var show = document.querySelectorAll(hiden);
                for (let i = 0; i < 90; i++) {
                    try {
                        show[i].style.display = 'table-cell';
                    } catch (e) {
                    }
                }

                var lim = operationid.charCodeAt(0);
                for (let i = curcolnum + 1; i > lim; i--) {
                    var dest = String.fromCharCode(i);
                    var sourc = String.fromCharCode(i - 1);
                    for (let j = 0; j < 90; j++) {
                        try {
                            document.getElementById(j.toString() + dest).value = document.getElementById(j.toString() + sourc).value;
                            if (sourc === operationid) {
                                document.getElementById(j.toString() + sourc).value = '';
                            }
                        } catch (e) {

                        }
                    }
                }
                lastreadonly();
                sendall();
            } else {
                alert('can\'t add more');
            }
        }


        function delcol() {
            notempty();
            if (curcolnum !== 66) {
                var lim = operationid.charCodeAt(0);
                for (let i = lim; i < curcolnum; i++) {
                    var dest = String.fromCharCode(i);
                    var sourc = String.fromCharCode(i + 1);
                    for (let j = 0; j < 90; j++) {
                        try {
                            document.getElementById(j.toString() + dest).value = document.getElementById(j.toString() + sourc).value;
                            if (sourc.charCodeAt(0) === curcolnum) {
                                document.getElementById(j.toString() + sourc).value = '';
                            }
                        } catch (e) {

                        }
                    }


                    var hiden = '.' + String.fromCharCode(curcolnum);
                    var hidenow = document.querySelectorAll(hiden);
                    for (let i = 0; i < 90; i++) {
                        try {
                            hidenow[i].style.display = 'none';
                        } catch (e) {
                        }
                    }
                }
                notempty();
                for (let i = 1; i < 90; i++) {
                    var total = '0';
                    for (let k = 65; k < 75; k++) {
                        try {
                            cellid = i.toString() + String.fromCharCode(k);
                            console.log(cellid);
                            if (k > 65) {
                                if (k < curcolnum)
                                    total = addsum(document.getElementById(cellid).value, total);
                                else if (k === curcolnum)
                                    document.getElementById(cellid).value = total;
                            }

                        } catch (e) {
                        }
                    }
                }
                lastreadonly();
                sendall();

            } else {
                alert('can\'t detete.');
            }
        }


        function myadd1(event) {
            {% if cons.submitted %}
                return;
            {% endif %}
            var ch = event.target.id;
            operationid = ch;
            var idis = "float" + ch;
            addid = ch.charCodeAt(0);
            const adddel = document.getElementById(idis);
            adddel.style.display = 'block';
            adddel.style.position = 'absolute';

            for (let i = 66; i < 75; i++) {
                if (String.fromCharCode(i) !== ch) {
                    var hideid = "float" + String.fromCharCode(i);
                    try {
                        document.getElementById(hideid).style.display = 'none';
                    } catch (e) {

                    }
                }
            }

        }

        function sendall() {
            for (let i = 0; i < 90; i++) {
                var aaacellvalue = {};
                var possible = 0;
                for (let k = 65; k < 75; k++) {
                    try {
                        cellid = i.toString() + String.fromCharCode(k);
                        aaacellvalue[cellid] = document.getElementById(cellid).value;
                        if (aaacellvalue[cellid] === '')
                            aaacellvalue[cellid] = 'None';

                    } catch (e) {
                        possible = 1;
                    }
                }
                if (possible === 0) {
                    $.ajax({
                        type: "POST",
                        url: url,
                        data:
                            {
                                aaacellvalue,
                                csrfmiddlewaretoken: '{{ csrf_token }}'
                            }
                    });
                }


            }
        }


        $(document).ready(function () {
            setTimeout('$("#hehe").css("opacity", 1)', 100);
        });

    </script>
{% endblock %}
